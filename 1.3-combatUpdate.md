# 1.3-combatUpdate

## Overview
- Implemented modular, deterministic combat engine with booster pipeline, effects bricks, and status runtime.
- Added comprehensive content registries for actions, statuses, items, and enemies.
- Integrated deterministic RNG utilities, Zustand combat store, and a headless dev harness.
- Introduced unit tests covering boosters, effects, statuses, items, and RNG determinism.
- Added seeded initiative rolls with deterministic tie-breaks and telemetry logging.

## Key Systems
- **Combat Engine** (`src/engine/combat/engine.ts`): orchestrates encounters, turn order, booster resolution, status ticks, and effect pipelines for player and AI.
- **Initiative System** (`src/engine/combat/formulas.ts` / `engine.ts`): rolls d20 for player vs. enemy via seeded RNG, applies SPD and coin-flip tiebreakers, stores results on the encounter, and logs telemetry.
- **Effects Pipeline** (`src/engine/combat/effects/index.ts`): pure functions applying bricks (HitCheck, Damage, ApplyStatus, Guard, etc.) with booster-aware behavior and status-derived damage.
- **Formulas** (`src/engine/combat/formulas.ts`): centralized math for hit/crit/damage/turn order.
- **Booster Registry** (`src/engine/combat/booster.ts`): precision/focus/reaction outcome tables with accessibility overrides and tuning hooks.
- **Status Runtime** (`src/engine/combat/statusRuntime.ts`): apply/refresh/expire logic, turn-phase ticking, and expire-triggered effects.
- **Telemetry** (`src/engine/combat/telemetry.ts`): structured hooks for action and status events.
- **Item Runtime** (`src/engine/items/itemRuntime.ts`): grants actions and scoped modifiers/booster tweaks from gear.
- **State Store** (`src/state/combatStore.ts`): Zustand store exposing `beginEncounter`, `commitPlayerDecision`, and `advanceTurn`.
- **Run Store** (`src/store/runStore.ts`): transitions exploration into combat, suppresses movement during fights, logs initiative to the journal, and marks rooms as cleared on victory.
- **Content Registries** (`src/content/**`): data-only modules for actions, statuses, items, enemies, with hub `src/content/index.ts`.
- **Dev Harness** (`src/dev/combatHarness.ts`): headless script producing transcript of scripted turns for smoke checks.
- **Tests** (`__tests__/combat/*.spec.ts`): coverage for effect gating, status ticks, booster outcomes, item modifiers, RNG determinism (requires `jest-environment-jsdom` dependency).

## Folder Tree (Combat Additions)
```
__tests__/combat/
├── booster.spec.ts
├── effects.spec.ts
├── items.spec.ts
├── rng.spec.ts
└── statuses.spec.ts
src/content/
├── actions/
│   ├── bite.ts
│   ├── cringe.ts
│   ├── defend.ts
│   ├── fireball.ts
│   ├── firebolt.ts
│   ├── slash.ts
│   ├── scratch.ts
│   └── weaken.ts
├── enemies/
│   ├── acolyte.ts
│   └── rat.ts
├── items/
│   ├── buckler.ts
│   ├── starter-staff.ts
│   └── starter-sword.ts
├── statuses/
│   ├── bleed.ts
│   ├── burn.ts
│   ├── freeze.ts
│   └── guarded.ts
└── index.ts
src/dev/combatHarness.ts
src/engine/combat/
├── booster.ts
├── effects/index.ts
├── engine.ts
├── formulas.ts
├── statusRuntime.ts
├── telemetry.ts
└── types.ts
src/engine/items/itemRuntime.ts
src/engine/rng.ts
src/state/combatStore.ts
```

## Data Contracts & Pipelines
- **Actions**: define targeting, booster, power, stat usage, and ordered `effects` list populated by bricks.
- **Statuses**: declare stacking, durations, phase hooks (`turnStart`, `turnEnd`, `onExpire`, etc.) with effect lists for each hook.
- **BoosterResult**: standardized fields (`damageMult`, `critBonus`, `statusBonus`, `guardBonus`, `reflectRatio`, `comboHits`, `counterChance`) plus metadata for specialized interactions (e.g., BreakGuard chance).
- **Effect Bricks**: each brick is a pure handler receiving `EffectContext` and returning updated encounter state plus resolution events.
- **Items**: grant actions and inject modifiers/booster tuning to targeted actions.

## Runtime Flow
1. `startEncounter` seeds deterministic RNG per encounter, builds player/enemy entities, assigns actions via items, and computes initiative.
2. `takeTurn`:
   - Runs `turnStart` status ticks via effect pipeline.
   - Executes player or AI action (`resolveAction`) with booster resolution (accessibility auto-good supported).
   - Applies `turnEnd` ticks and status expirations (including on-expire effects like burn detonations).
   - Decrements guard durations, prunes defeated entities, advances initiative pointer.
3. `runEffectPipeline` processes bricks in order, short-circuiting on misses where appropriate, and records telemetry-ready resolution events.

## Developer Notes
- **Deterministic RNG**: use `createSeededRNG`/`forkRng` from `src/engine/rng.ts`; `SeededRNG.clone()` preserves sequences for branching simulations.
- **Accessibility**: `accessibility.autoGood` ensures boosters default to "good" unless UI supplies explicit outcome.
- **Telemetry**: `Resolution.telemetry` currently buffers events via `TelemetryBus`; integrate with UI/devtools by consuming structured records.
- **Initiative History**: `Encounter.initiative` captures the latest roll ({ player, enemy, first }) and `Encounter.telemetry` accumulates events starting with the initiative record.
- **AI Actions**: enemy plans defined in content with weighted actions and optional booster bias.
- **Status Damage**: status-driven damage scales via stacks and originating stats; extend `statusRuntime` hooks for future on-hit/on-damaged behaviors.
- **Guard Mechanics**: guard ratios apply per damage brick; booster guard bonuses merge with Guard effect ratios.
- **Dev Harness**: run `ts-node src/dev/combatHarness.ts` (or equivalent) to print transcript showing slash perfect (BreakGuard), fireball good (Burn), defend perfect (Guard + Counter).
- **Journal Hooks**: entering combat appends an initiative summary to the run journal; victories extend the entry with a cleared-room note and convert the room to empty.
- **Testing**: install `jest-environment-jsdom` (`npx npm install jest-environment-jsdom -D`) before running `npx jest __tests__/combat/*`. Tests leverage combat engine directly (no UI).
- **Future Extensions**: fill TODO for freeze chill conversion, expand telemetry consumer, flesh out status immunities/blocked interactions, add AI target heuristics.
## Upgrade Checklist
- `npm install --save-dev jest-environment-jsdom` (needed due to Jest 28+ packaging).
- Verify `tsconfig` and path aliases (`@/`) when moving files.
- Update UI flows to consume `useCombatStore` methods without embedding gameplay logic.
- Document new actions/statuses in public design docs and align any live data exports.
