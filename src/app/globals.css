/* =========================================================
   GLOBALS — The Tower (Pocket Run Edition)
   - Mobile-first, one-thumb UX
   - Background/overlay via CSS variables (PageSurface)
   - CRT theme (optional) with reduced-motion respect
   ========================================================= */

/* ---------- Theme Vars ---------- */
:root{
  /* Core palette */
  --bg: #0b0a0f;
  --panel: #15121d;
  --ink: #e8e5ff;
  --muted: #aaa6c7;
  --line: #2b2640;
  --accent: #d7c3ff;
  --shadow: rgba(0,0,0,.35);

  /* Layout */
  --topbar-height: 48px;

  /* PageSurface pipeline (set by component per page) */
  --page-background: none;   /* e.g. url("/backgrounds/inn.jpg") */
  --page-overlay: none;      /* e.g. linear-gradient(...) */

  /* CRT */
  --crt-scanline-opacity: .12;
  --crt-vignette-opacity: .35;
  --crt-noise-opacity: .035;
  --crt-flicker-min: .96;
  --crt-flicker-max: 1;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; }
html { color-scheme: dark; }
body{
  margin: 0;
  min-height: 100dvh;
  background:
    radial-gradient(1200px 600px at 50% -10%, #1b1533 0%, var(--bg) 60%);
  color: var(--ink);
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
}

/* ---------- Top Bar ---------- */
.topbar{
  position: sticky; top: 0; z-index: 20;
  display: flex; align-items: center; justify-content: space-between;
  height: var(--topbar-height); padding: 0 12px;
  background: rgba(19,17,26,.7);
  border-bottom: 1px solid var(--line);
  backdrop-filter: blur(6px) saturate(120%);
}
.userbox{ display:flex; align-items:center; gap:10px; min-width:0; }
.avatar{
  width:28px; height:28px; border-radius:50%; object-fit:cover;
  border:1px solid var(--line);
}
.avatar--fallback{
  display:grid; place-items:center; width:28px; height:28px;
  border-radius:50%; background:#2a2440; color:var(--accent); font-weight:700;
}
.who{ font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:60vw; }
.link{ background:none; border:none; color:var(--accent); padding:8px 10px; font-weight:600; }

/* ---------- PageSurface Helpers ---------- */
/* Use <PageSurface class="page">… or .page--full for full-viewport scenes */
.page{
  position: relative;
  min-height: calc(100dvh - var(--topbar-height));
  isolation: isolate; /* keep pseudo layers behind content */
}
.page--full{ min-height: 100dvh; }

/* Background image (from --page-background) */
.page::before{
  content:"";
  position:absolute; inset:0;
  background-image: var(--page-background);
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  z-index: -2;
}

/* Optional per-page overlay tint (from --page-overlay) */
.page::after{
  content:"";
  position:absolute; inset:0;
  background: var(--page-overlay);
  z-index: -1;
}

/* Ensure children paint above BG/overlay */
.page > * { position: relative; z-index: 0; }

/* ---------- Centered Panel / Menu (FarmRPG-style shell) ---------- */
.tower-shell{
  min-height: inherit; /* matches .page or viewport */
  display: grid; place-items: center; padding: 16px;
}

.menu-panel{
  width: 100%; max-width: 420px;
  background: linear-gradient(180deg, #1b1727, #13101a);
  border: 1px solid var(--line);
  border-radius: 24px;
  box-shadow: 0 12px 24px var(--shadow), inset 0 0 0 1px rgba(255,255,255,.02);
  padding: 18px 16px 14px;
}

.panel-title{
  font-size: 18px; font-weight: 700; text-align: center; margin: 4px 0 8px;
  letter-spacing: .02em;
  text-shadow:
    0 0 6px rgba(197,163,255,.18),
    1px 0 0 rgba(255,0,0,.08),
   -1px 0 0 rgba(0,255,255,.08);
}
.panel-sub{ margin: -2px 0 12px; text-align: center; color: var(--muted); }
.panel-body{ display:flex; flex-direction:column; gap:10px; }

/* Menu list */
.menu-list{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:10px; }
.menu-link{
  display:grid; grid-template-columns:1fr auto; grid-template-rows:auto auto; gap: 0 10px;
  align-items:center; text-decoration:none; color:inherit;
  padding:14px 14px; border-radius:16px;
  background: rgba(255,255,255,.03);
  border: 1px solid var(--line);
  box-shadow: 0 2px 0 rgba(0,0,0,.2);
  transition: transform .02s ease, background .15s ease;
}
.menu-link:active{ transform: translateY(1px); }
.menu-label{ grid-column:1 / 2; grid-row:1; font-weight:700; }
.menu-sub{ grid-column:1 / 2; grid-row:2; font-size:12px; color:var(--muted); }
.menu-chev{ grid-column:2 / 3; grid-row:1 / 3; align-self:center; opacity:.7; font-size:20px; }
@media (pointer:coarse){
  .menu-link{ min-height:56px; }
}

/* ---------- Buttons ---------- */
.btn{
  min-height:56px; border-radius:16px; border:1px solid var(--line);
  padding:12px 16px; font-weight:700; display:flex; justify-content:center; align-items:center;
}
.btn--primary{ background: linear-gradient(180deg,#2b2344,#1c172b); }
.btn--secondary{ background: rgba(255,255,255,.04); }

/* ---------- CRT THEME (toggle by adding .crt to <html>) ---------- */
html.crt body { position: relative; isolation: isolate; }

/* Vignette */
html.crt body::before{
  content:""; position: fixed; inset: 0; pointer-events: none; z-index: 1;
  background: radial-gradient(120% 120% at 50% 50%, rgba(0,0,0,0) 60%, rgba(0,0,0,var(--crt-vignette-opacity)) 100%);
}

/* Scanlines + faint RGB subpixel drift */
html.crt body::after{
  content:""; position: fixed; inset: 0; pointer-events: none; z-index: 2;
  background:
    linear-gradient(0deg, rgba(255,0,0,.03), rgba(0,255,255,.03)),
    repeating-linear-gradient(
      to bottom,
      rgba(255,255,255,var(--crt-scanline-opacity)) 0px,
      rgba(255,255,255,var(--crt-scanline-opacity)) 1px,
      rgba(0,0,0,0) 2px,
      rgba(0,0,0,0) 4px
    );
  mix-blend-mode: overlay;
  animation: crt-drift 7s linear infinite, crt-flicker 2.4s steps(2, end) infinite;
  will-change: transform, opacity;
}

/* Noise layer — mount a single <div class="crt-noise" /> in layout */
html.crt .crt-noise{
  position: fixed; inset: 0; pointer-events: none; z-index: 3;
  opacity: var(--crt-noise-opacity);
  background-image:
    url("data:image/svg+xml;utf8,\
      <svg xmlns='http://www.w3.org/2000/svg' width='128' height='128'>\
        <filter id='n'><feTurbulence type='fractalNoise' baseFrequency='.95' numOctaves='2' stitchTiles='stitch'/></filter>\
        <rect width='100%%' height='100%%' filter='url(#n)' opacity='.9'/>\
      </svg>");
  background-size: 256px 256px;
  animation: crt-noise 1.2s steps(4,end) infinite;
  will-change: transform;
}

/* Slight saturation/contrast lift in CRT */
html.crt body, html.crt .menu-panel, html.crt .menu-link{
  filter: saturate(110%) contrast(102%);
}

/* Animations */
@keyframes crt-drift{
  0% { transform: translateY(0px); }
  50%{ transform: translateY(-0.5px); }
  100%{ transform: translateY(0px); }
}
@keyframes crt-flicker{
  0%{ opacity: var(--crt-flicker-max); }
  50%{ opacity: var(--crt-flicker-min); }
  100%{ opacity: var(--crt-flicker-max); }
}
@keyframes crt-noise{
  0%{ transform: translate(0,0); }
  25%{ transform: translate(-5%, 3%); }
  50%{ transform: translate(4%, -2%); }
  75%{ transform: translate(-3%, -4%); }
  100%{ transform: translate(0,0); }
}

/* Accessibility: respect reduced motion */
@media (prefers-reduced-motion: reduce){
  html.crt body::after,
  html.crt .crt-noise{ animation: none; }
}

/* ---------- Utilities ---------- */
.visually-hidden, .sr-only{
  position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
}
.container{ width:100%; max-width:720px; margin:0 auto; padding:0 16px; }
:root[data-bigtext] { font-size: 18px; }
:root[data-hc] { filter: contrast(1.1) saturate(1.05); }